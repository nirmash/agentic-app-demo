<!DOCTYPE html>
<html lang="en" data-color-mode="dark" data-dark-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Database Explorer</title>
  <link rel="stylesheet" href="https://unpkg.com/@primer/css@21.3.1/dist/primer.css">
  <style>
    body { background-color: var(--bgColor-default, #0d1117); color: var(--fgColor-default, #e6edf3); }
    .container { max-width: 960px; margin: 2rem auto; padding: 0 1rem; }
    .query-box {
      width: 100%;
      min-height: 80px;
      background: var(--bgColor-muted, #161b22);
      color: var(--fgColor-default, #e6edf3);
      border: 1px solid var(--borderColor-default, #30363d);
      border-radius: 6px;
      padding: 0.75rem;
      font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace;
      font-size: 14px;
      resize: vertical;
    }
    .query-box:focus { outline: none; border-color: var(--color-accent-fg, #2f81f7); box-shadow: 0 0 0 3px rgba(47,129,247,0.3); }
    .results-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .results-table th, .results-table td {
      border: 1px solid var(--borderColor-default, #30363d);
      padding: 6px 10px;
      text-align: left;
      white-space: nowrap;
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .results-table th { background: var(--bgColor-muted, #161b22); font-weight: 600; position: sticky; top: 0; }
    .results-table tr:hover td { background: rgba(47,129,247,0.08); }
    .results-wrap { max-height: 500px; overflow: auto; border: 1px solid var(--borderColor-default, #30363d); border-radius: 6px; }
    .sidebar-table { cursor: pointer; }
    .sidebar-table:hover { color: var(--color-accent-fg, #2f81f7); }
    .sidebar-table.active { color: var(--color-accent-fg, #2f81f7); font-weight: 600; }
    .error-msg { color: var(--fgColor-danger, #f85149); font-family: monospace; }
    .status-bar { font-size: 13px; color: var(--fgColor-muted, #8b949e); }
    .keyboard-hint { font-size: 12px; color: var(--fgColor-muted, #8b949e); }
  </style>
</head>
<body>
  <div class="container">
    <div class="Subhead mb-3">
      <h1 class="Subhead-heading">üóÑÔ∏è Database Explorer</h1>
      <div class="Subhead-description"><a href="/" class="Link">‚Üê Back to forms</a></div>
    </div>

    <div class="d-flex flex-column flex-md-row" style="gap: 1rem;">
      <!-- Sidebar: tables -->
      <div class="col-md-3">
        <div class="Box">
          <div class="Box-header"><h3 class="Box-title">Tables</h3></div>
          <div id="tables-list" class="Box-body p-2">
            <span class="color-fg-muted">Loading...</span>
          </div>
        </div>
      </div>

      <!-- Main: query + results -->
      <div class="col-md-9 flex-auto">
        <div class="mb-2">
          <textarea id="sql-input" class="query-box" placeholder="SELECT * FROM ..." spellcheck="false">SELECT tablename FROM pg_tables WHERE schemaname = 'public'</textarea>
        </div>
        <div class="d-flex flex-items-center mb-3" style="gap: 0.5rem;">
          <button id="run-btn" class="btn btn-primary btn-sm">‚ñ∂ Run Query</button>
          <span class="keyboard-hint">Ctrl+Enter to run</span>
          <span id="status" class="status-bar flex-auto text-right"></span>
        </div>
        <div id="results"></div>
      </div>
    </div>
  </div>

  <script>
    const sqlInput = document.getElementById('sql-input');
    const runBtn = document.getElementById('run-btn');
    const resultsDiv = document.getElementById('results');
    const statusEl = document.getElementById('status');
    const tablesList = document.getElementById('tables-list');

    // Load tables sidebar
    async function loadTables() {
      try {
        const res = await fetch('/api/db/tables');
        const data = await res.json();
        if (!data.ok) { tablesList.textContent = data.error; return; }
        if (data.tables.length === 0) {
          tablesList.innerHTML = '<span class="color-fg-muted">No tables yet</span>';
          return;
        }
        tablesList.innerHTML = data.tables.map(t =>
          `<div class="sidebar-table p-1" data-table="${t}">üìä ${t}</div>`
        ).join('');
        tablesList.querySelectorAll('.sidebar-table').forEach(el => {
          el.addEventListener('click', () => {
            tablesList.querySelectorAll('.sidebar-table').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            sqlInput.value = `SELECT * FROM "${el.dataset.table}" LIMIT 50`;
            runQuery();
          });
        });
      } catch (err) {
        tablesList.innerHTML = `<span class="error-msg">${err.message}</span>`;
      }
    }

    // Run query
    async function runQuery() {
      const sql = sqlInput.value.trim();
      if (!sql) return;
      runBtn.disabled = true;
      statusEl.textContent = 'Running...';
      resultsDiv.innerHTML = '';
      const t0 = performance.now();
      try {
        const res = await fetch('/api/db/query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sql })
        });
        const data = await res.json();
        const ms = Math.round(performance.now() - t0);
        if (!data.ok) {
          resultsDiv.innerHTML = `<div class="flash flash-error p-3"><pre class="error-msg m-0">${escHtml(data.error)}</pre></div>`;
          statusEl.textContent = `Error (${ms}ms)`;
          return;
        }
        if (!data.rows || data.rows.length === 0) {
          resultsDiv.innerHTML = '<div class="flash p-3">Query OK ‚Äî no rows returned</div>';
          statusEl.textContent = `${data.rowCount ?? 0} row(s) affected (${ms}ms)`;
          return;
        }
        const cols = Object.keys(data.rows[0]);
        const header = cols.map(c => `<th>${escHtml(c)}</th>`).join('');
        const rows = data.rows.map(r =>
          '<tr>' + cols.map(c => `<td title="${escHtml(String(r[c] ?? ''))}">${escHtml(String(r[c] ?? 'NULL'))}</td>`).join('') + '</tr>'
        ).join('');
        resultsDiv.innerHTML = `<div class="results-wrap"><table class="results-table"><thead><tr>${header}</tr></thead><tbody>${rows}</tbody></table></div>`;
        statusEl.textContent = `${data.rows.length} row(s) returned (${ms}ms)`;
      } catch (err) {
        resultsDiv.innerHTML = `<div class="flash flash-error p-3"><pre class="error-msg m-0">${escHtml(err.message)}</pre></div>`;
        statusEl.textContent = 'Connection error';
      } finally {
        runBtn.disabled = false;
      }
    }

    function escHtml(s) {
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    runBtn.addEventListener('click', runQuery);
    sqlInput.addEventListener('keydown', e => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); runQuery(); }
    });

    loadTables();
  </script>

  <!-- CLI Terminal Section -->
  <div class="container" style="margin-top: 2rem;">
    <div class="Subhead mb-3">
      <h1 class="Subhead-heading">‚å®Ô∏è adcgen CLI</h1>
      <div class="Subhead-description">Run adcgen commands to generate and manage forms</div>
    </div>

    <!-- Login Panel -->
    <div id="cli-login-panel" class="Box mb-3 p-3">
      <div class="d-flex flex-items-center" style="gap: 0.75rem;">
        <span id="auth-icon" style="font-size: 1.4em;">üîí</span>
        <div class="flex-auto">
          <div id="auth-status-text" class="text-bold">Checking authentication...</div>
          <div id="auth-detail" class="color-fg-muted" style="font-size: 13px;"></div>
        </div>
        <div id="auth-actions"></div>
      </div>
      <!-- Token input (hidden by default) -->
      <div id="token-input-row" class="d-flex mt-2" style="gap: 0.5rem; display: none !important;">
        <input id="token-input" type="password" class="form-control input-sm flex-auto" placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" style="font-family: monospace;">
        <button id="token-submit" class="btn btn-sm btn-primary">Save Token</button>
        <button id="token-cancel" class="btn btn-sm">Cancel</button>
      </div>
    </div>

    <!-- CLI Terminal (hidden until logged in) -->
    <div id="cli-terminal" style="display: none;">
      <div class="Box" style="background: #0d1117; border: 1px solid var(--borderColor-default, #30363d); border-radius: 6px; padding: 1rem; font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace; font-size: 13px;">
        <div id="cli-output" style="max-height: 400px; overflow-y: auto; white-space: pre-wrap; color: var(--fgColor-default, #e6edf3); margin-bottom: 0.75rem; min-height: 60px;">
<span style="color: #8b949e;">Ready. Type a command below (e.g. "adcgen list" or "adcgen --help").</span>
</div>
        <div class="d-flex" style="gap: 0.5rem;">
          <span style="color: #3fb950; flex-shrink: 0; line-height: 32px;">$</span>
          <input id="cli-input" type="text" value="adcgen list" spellcheck="false"
            style="flex: 1; background: transparent; border: 1px solid var(--borderColor-default, #30363d); border-radius: 4px; color: var(--fgColor-default, #e6edf3); padding: 4px 8px; font-family: inherit; font-size: inherit; outline: none;"
            placeholder="adcgen --help">
          <button id="cli-run" class="btn btn-sm" style="flex-shrink: 0;">Run</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const cliInput = document.getElementById('cli-input');
    const cliOutput = document.getElementById('cli-output');
    const cliRun = document.getElementById('cli-run');
    const cliTerminal = document.getElementById('cli-terminal');
    const loginPanel = document.getElementById('cli-login-panel');
    const authIcon = document.getElementById('auth-icon');
    const authStatusText = document.getElementById('auth-status-text');
    const authDetail = document.getElementById('auth-detail');
    const authActions = document.getElementById('auth-actions');
    const tokenInputRow = document.getElementById('token-input-row');
    const tokenInput = document.getElementById('token-input');
    const tokenSubmit = document.getElementById('token-submit');
    const tokenCancel = document.getElementById('token-cancel');
    const cmdHistory = [];
    let histIdx = -1;

    // Auth flow
    async function checkAuth() {
      try {
        const res = await fetch('/api/cli/auth-status');
        const data = await res.json();
        if (data.loggedIn) {
          showLoggedIn(data.user);
        } else if (data.ghCliAvailable) {
          showGhAvailable();
        } else {
          showLoggedOut();
        }
      } catch {
        showLoggedOut();
      }
    }

    function showLoggedIn(user) {
      authIcon.textContent = 'üîì';
      authStatusText.textContent = `Logged in as ${user}`;
      authDetail.textContent = 'CLI commands can access the GitHub API.';
      authActions.innerHTML = '<button class="btn btn-sm btn-danger" id="logout-btn">Logout</button>';
      document.getElementById('logout-btn').onclick = doLogout;
      tokenInputRow.style.display = 'none';
      cliTerminal.style.display = '';
    }

    function showGhAvailable() {
      authIcon.textContent = 'üîë';
      authStatusText.textContent = 'GitHub CLI detected';
      authDetail.textContent = 'Click "Login with gh CLI" to authenticate, or paste a personal access token.';
      authActions.innerHTML = `
        <button class="btn btn-sm btn-primary mr-1" id="gh-login-btn">Login with gh CLI</button>
        <button class="btn btn-sm" id="manual-login-btn">Paste Token</button>
      `;
      document.getElementById('gh-login-btn').onclick = doGhLogin;
      document.getElementById('manual-login-btn').onclick = showTokenInput;
      cliTerminal.style.display = 'none';
    }

    function showLoggedOut() {
      authIcon.textContent = 'üîí';
      authStatusText.textContent = 'Not logged in';
      authDetail.textContent = 'Paste a GitHub personal access token to get started.';
      authActions.innerHTML = '<button class="btn btn-sm btn-primary" id="manual-login-btn">Paste Token</button>';
      document.getElementById('manual-login-btn').onclick = showTokenInput;
      cliTerminal.style.display = 'none';
    }

    function showTokenInput() {
      tokenInputRow.style.cssText = 'display: flex !important; gap: 0.5rem;';
      tokenInput.focus();
    }

    tokenCancel.onclick = () => { tokenInputRow.style.display = 'none'; tokenInput.value = ''; };

    tokenSubmit.onclick = () => doTokenLogin(tokenInput.value.trim());
    tokenInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') doTokenLogin(tokenInput.value.trim());
    });

    async function doGhLogin() {
      authStatusText.textContent = 'Logging in via gh CLI...';
      try {
        const res = await fetch('/api/cli/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}' });
        const data = await res.json();
        if (data.ok) { showLoggedIn(data.user); } else { authDetail.textContent = data.error; showTokenInput(); }
      } catch (err) { authDetail.textContent = 'Login failed: ' + err.message; }
    }

    async function doTokenLogin(token) {
      if (!token) return;
      tokenSubmit.disabled = true;
      try {
        const res = await fetch('/api/cli/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ token }) });
        const data = await res.json();
        if (data.ok) { tokenInput.value = ''; tokenInputRow.style.display = 'none'; showLoggedIn(data.user); }
        else { authDetail.textContent = data.error; }
      } catch (err) { authDetail.textContent = 'Login failed: ' + err.message; }
      tokenSubmit.disabled = false;
    }

    async function doLogout() {
      await fetch('/api/cli/logout', { method: 'POST' });
      checkAuth();
    }

    // LLM config for browser-side calls
    const LLM_ENDPOINT = 'https://models.inference.ai.azure.com/chat/completions';
    const LLM_MODEL = 'gpt-4o';

    async function getAuthToken() {
      const res = await fetch('/api/cli/token');
      const data = await res.json();
      return data.ok ? data.token : null;
    }

    async function callLLM(systemPrompt, userPrompt, token) {
      const res = await fetch(LLM_ENDPOINT, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ model: LLM_MODEL, messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: userPrompt }], temperature: 0.7, max_tokens: 4000 })
      });
      if (!res.ok) throw new Error(`LLM API error (${res.status}): ${await res.text()}`);
      const data = await res.json();
      const content = data.choices?.[0]?.message?.content;
      if (!content) throw new Error('No response from LLM');
      return content.replace(/^```(?:json|html)?\n?/m, '').replace(/\n?```$/m, '').trim();
    }

    // Handle generate command browser-side (LLM call from browser, save on server)
    async function handleGenerate(args) {
      // Parse: adcgen generate <name> <description...>
      const name = args[0];
      const description = args.slice(1).join(' ');
      if (!name) { cliOutput.innerHTML += `<span style="color:#f85149;">Usage: adcgen generate &lt;form_name&gt; &lt;description&gt;</span>\n`; return; }
      if (!description) { cliOutput.innerHTML += `<span style="color:#f85149;">Please provide a form description after the name.</span>\n`; return; }

      const formName = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
      cliOutput.innerHTML += `<span style="color:#8b949e;">‚è≥ Generating form "${formName}"...</span>\n`;
      cliOutput.scrollTop = cliOutput.scrollHeight;

      const token = await getAuthToken();
      if (!token) { cliOutput.innerHTML += `<span style="color:#f85149;">Not logged in. Use the login panel above.</span>\n`; return; }

      try {
        const raw = await callLLM(GENERATE_SYSTEM_PROMPT, description, token);
        const spec = JSON.parse(raw);
        spec.formName = formName;

        cliOutput.innerHTML += `<span style="color:#3fb950;">‚úì Generated: "${spec.title}" (${(spec.sections || []).reduce((n, s) => n + (s.fields || []).length, 0)} fields)</span>\n`;
        cliOutput.innerHTML += `<span style="color:#8b949e;">Saving and building...</span>\n`;
        cliOutput.scrollTop = cliOutput.scrollHeight;

        const saveRes = await fetch('/api/cli/save-form', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ spec })
        });
        const saveData = await saveRes.json();
        if (saveData.ok) {
          cliOutput.innerHTML += `<span style="color:#3fb950;">‚úì Form saved: /${formName}/</span>\n`;
          cliOutput.innerHTML += `<span style="color:#8b949e;">  Open: <a href="/${formName}/" target="_blank" style="color:#58a6ff;">/${formName}/</a></span>\n`;
        } else {
          cliOutput.innerHTML += `<span style="color:#f85149;">Save error: ${escHtml(saveData.error)}</span>\n`;
        }
      } catch (err) {
        cliOutput.innerHTML += `<span style="color:#f85149;">‚ùå ${escHtml(err.message)}</span>\n`;
      }
      cliOutput.scrollTop = cliOutput.scrollHeight;
    }

    const GENERATE_SYSTEM_PROMPT = `You are a form design assistant. Given a user's description of a data entry form, produce a JSON specification.

Return ONLY valid JSON (no markdown fences, no explanation) matching this schema:

{
  "title": "Form Title",
  "formName": "snake_case_form_name",
  "sections": [
    {
      "heading": "Section Title",
      "fields": [
        {
          "type": "text|password|dropdown|checkbox|radio|table|button|link",
          "label": "Field Label",
          "name": "field_name",
          "placeholder": "optional placeholder",
          "required": true|false,
          "options": ["opt1", "opt2"],
          "href": "/page_name/",
          "columns": [{ "header": "Col Name", "type": "text|dropdown|checkbox|calculated", "name": "col_name", "options": [], "formula": "{col1} {col2}" }],
          "initialRows": 1,
          "events": [{ "event": "click|change|input", "description": "What should happen", "handler": "// JS code" }]
        }
      ]
    }
  ]
}

Rules:
- Use "password" type for secrets. Use "link" type for navigation (href: "/page_name/").
- "options" is for dropdown/radio only. "columns"/"initialRows" for table only.
- Use snake_case for all "name" fields. Always include a submit button.
- IMPORTANT: The form always has id="main-form". Any submit handler MUST use: document.getElementById('main-form').requestSubmit()
- Do NOT generate "Add Row"/"Delete Row" buttons for tables (system adds those).
- Set initialRows to 1 for tables. Be creative but practical.`;

    // CLI execution
    async function runCli() {
      const cmd = cliInput.value.trim();
      if (!cmd) return;
      cmdHistory.unshift(cmd);
      histIdx = -1;

      cliOutput.innerHTML += `\n<span style="color:#3fb950;">$ ${escHtml(cmd)}</span>\n`;
      cliInput.value = '';
      cliRun.disabled = true;

      const parts = cmd.trim().split(/\s+/);
      const subCmd = parts[1];

      // Intercept generate/edit ‚Äî run browser-side (LLM needs internet)
      if ((parts[0] === 'adcgen' || parts[0] === 'adc') && subCmd === 'generate') {
        await handleGenerate(parts.slice(2));
        cliRun.disabled = false;
        return;
      }

      try {
        const res = await fetch('/api/cli/exec', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ command: cmd })
        });
        const data = await res.json();
        if (data.ok) {
          cliOutput.innerHTML += escHtml(data.output);
        } else {
          cliOutput.innerHTML += `<span style="color:#f85149;">${escHtml(data.error)}</span>`;
        }
      } catch (err) {
        cliOutput.innerHTML += `<span style="color:#f85149;">Error: ${escHtml(err.message)}</span>`;
      }
      cliRun.disabled = false;
      cliOutput.scrollTop = cliOutput.scrollHeight;
    }

    cliRun.addEventListener('click', runCli);
    cliInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') { e.preventDefault(); runCli(); }
      if (e.key === 'ArrowUp' && cmdHistory.length > 0) {
        histIdx = Math.min(histIdx + 1, cmdHistory.length - 1);
        cliInput.value = cmdHistory[histIdx];
      }
      if (e.key === 'ArrowDown') {
        histIdx = Math.max(histIdx - 1, -1);
        cliInput.value = histIdx >= 0 ? cmdHistory[histIdx] : '';
      }
    });

    checkAuth();
  </script>
</body>
</html>
